import csv # imports module for reading CSV files
import os # imports module for creating a directory to put license files in

# Define script-wide variable so you don't have to hunt for them

csvFile = r"ESRI License Management - 2020_License_Renewals.csv" # the CSV file of licensees that you have to parse
proConcAuthFile = r"arcpro_concurrent_authcodes_2020.txt" # 2020 ArcGIS Pro concurrent license Authorization codes - already formatted
proSingAuthFile = r"arcpro_single_authcodes_2020.txt" # 2020 ArcGIS Pro single-use license Authorization codes - already formatted
DeskConcAuthFile = r"desktop_concurrent_authcodes_2020.txt" # 2020 ArcGIS Desktop concurrent license Authorization codes - already formatted
DeskSingAuthFile = r"desktop_single_authcodes_2020.txt" # 2020 ArcGIS Desktop single-use license Authorization codes - already formatted
outPath = "./2020LicenseFiles"

os.mkdir(outPath)

# ---read in the CSV file.

with open(csvFile, newline="") as inputFile: # Newline is required if opening a file object according to python.org.  'with' Closes file automatically and ostensibly handles exceptions (?)
    print("Reading CSV file")
    row_num = 0 # setting up an iterator
    csvReader = csv.DictReader(inputFile, delimiter=",", quotechar ="\"") # reads each line into Dictionary object. Unless otherwise specified first row of CSV is put into a "fieldnames" parameter
        # automatically parses each column into objects.  Do not have to put each column into variables.
    print("Parsing CSV file")

    # ---Write out to license file

    for row in csvReader:
        row_num = row_num + 1 # iterator
        print("Processing row {} in file".format(row_num))

        # Skips over rows that include licenses you've already done or you have to do manually.
        if row['done'] != "": # Skip over line if License is already done
            print("This license file has already been generated by MyESRI")
            pass
        elif row['do_manually'] != "":  # Skip over line if License has to be done manually
            print("You have to do this license file manually")
            pass

        # Generate ArcPro license
        elif row['Product'] == "Pro":

            # Failsafe just in case a non-Pro product gets in there and isn't coded under 'Product' column
            # if row['License Type'] != "Single Use" or row['License Type'] != "Concurrent Use":
            #     pass

            # Generate Single Use ArcPro licenses
            if row['License Type'] == "Single Use":
                print("Generating ArcPro Single Use license for row {}".format(row_num))
                outFileName = str(row['Institution'] + "_ArcGIS" + row['Product'] + "_" + row['License Type'] + "_for_" + row['FirstName'] + "_" + row['LastName'] + "_" + str(row['Kopera File ID'])+r".prvc")
                outFileNameAndPath = str("{}/{}".format(outPath,outFileName))
                with open(outFileNameAndPath,'a', encoding='cp1252') as outFile:
                    outFile.write("// {}\n".format(outFileName))
                    outFile.write("\n")
                    outFile.write("//Provision\n")
                    outFile.write("Comment={}".format(str(row['Institution'] + ": " + "ArcGIS"+row['Product'] + " " + row['License Type'] + "License" + " for " + row['FirstName'] + " " + row['LastName']+"\n")))
                    outFile.write("\n")
                    outFile.write("\n")
                    outFile.write("// User Information\n")
                    outFile.write("First Name={}\n".format(row['FirstName']))
                    outFile.write("Last Name={}\n".format(row['LastName']))
                    outFile.write("Department=Please fill me in\n")
                    outFile.write("Organization=Please fill me in\n")
                    outFile.write("Department=Please fill me in\n")
                    outFile.write("Email={}\n".format(row['Email']))
                    outFile.write("Address 1=Please fill me in\n")
                    outFile.write("State/Province=MA\n")
                    outFile.write("Location Code=US\n")
                    outFile.write("Location=US\n")
                    outFile.write("Zip/Postal Code=00000-0000\n")
                    outFile.write("Phone Number=000-000-0000\n")
                    outFile.write("\n")
                    outFile.write("// Features and authorization numbers\n")
                    with open(proSingAuthFile,'r') as authCodes: # Brings in authorization codes from external file so I don't have to hardcode them each year + folks on github don't steal our licenses
                        for x in authCodes: # Python automagically loads the text file as if each line in it were an item in a list.
                            outFile.write(x)
                    outFile.write("\n")
                print("Done writing file {}".format(outFileNameAndPath))

                # print(outFilenName)

            # Generate Concurrent use ArcPro licenses
            elif row['License Type'] == "Concurrent Use":
                print("Generating ArcPro Concurrent Use license for row{}".format(row_num))
                print(outFileName)
                outFileName = str(row['Institution'] + "_ArcGIS" + row['Product'] + "_" + row['License Type'] + "_for_" + row['FirstName'] + "_" + row['LastName'] + "_" + str(row['Kopera File ID'])+r".prvs")
                outFileNameAndPath = str("{}/{}".format(outPath,outFileName))
                with open(outFileNameAndPath,'a', encoding='cp1252') as outFile:
                    outFile.write("// {}\n".format(outFileName))
                    outFile.write("\n")
                    outFile.write("//Provision\n")
                    outFile.write("Comment={}".format(str(row['Institution'] + ": " + "ArcGIS"+row['Product'] + " " + row['License Type'] + "License" + " for " + row['FirstName'] + " " + row['LastName'] + ", " + row['Seats'] + " seats\n")))
                    outFile.write("\n")
                    outFile.write("\n")
                    outFile.write("// User Information\n")
                    outFile.write("First Name={}\n".format(row['FirstName']))
                    outFile.write("Last Name={}\n".format(row['LastName']))
                    outFile.write("Department=Please fill me in\n")
                    outFile.write("Organization=Please fill me in\n")
                    outFile.write("Department=Please fill me in\n")
                    outFile.write("Email={}\n".format(row['Email']))
                    outFile.write("Address 1=Please fill me in\n")
                    outFile.write("State/Province=MA\n")
                    outFile.write("Location Code=US\n")
                    outFile.write("Location=US\n")
                    outFile.write("Zip/Postal Code=00000-0000\n")
                    outFile.write("Phone Number=000-000-0000\n")
                    outFile.write("\n")
                    outFile.write("// Features and authorization numbers\n")
                    with open(proConcAuthFile,'r') as authCodes: # Brings in authorization codes from external file so I don't have to hardcode them each year + folks on github don't steal our licenses
                        for x in authCodes: # Python automagically loads the text file as if each line in it were an item in a list.
                            lineOut = x.rstrip("\n") + "=" + row['Seats'] + "\n"
                            outFile.write(lineOut)
                print("Done writing file {}".format(outFileNameAndPath))

        # Generate ArcDesktop license
        elif row['Product'] == "Desktop":

            # Failsafe just in case a non-Desktop product gets in there and isn't coded under 'Product' column
            # if row['License Type'] != "Single Use" or row['License Type'] != "Concurrent Use":
            #     pass

            # Generate Single Use ArcDesktop licenses
            if row['License Type'] == "Single Use":
                print("Generating ArcPro Single Use license for row {}".format(row_num))
                outFileName = str(row['Institution'] + "_ArcGIS" + row['Product'] + "_" + row['License Type'] + "_for_" + row['FirstName'] + "_" + row['LastName'] + "_" + str(row['Kopera File ID'])+r".prvc")
                outFileNameAndPath = str("{}/{}".format(outPath,outFileName))
                with open(outFileNameAndPath,'a', encoding='cp1252') as outFile:
                    outFile.write("// {}\n".format(outFileName))
                    outFile.write("\n")
                    outFile.write("//Provision\n")
                    outFile.write("Comment={}".format(str(row['Institution'] + ": " + "ArcGIS"+row['Product'] + " " + row['License Type'] + " License" + " for " + row['FirstName'] + " " + row['LastName']+"\n")))
                    outFile.write("\n")
                    outFile.write("\n")
                    outFile.write("// User Information\n")
                    outFile.write("First Name={}\n".format(row['FirstName']))
                    outFile.write("Last Name={}\n".format(row['LastName']))
                    outFile.write("Department=Please fill me in\n")
                    outFile.write("Organization=Please fill me in\n")
                    outFile.write("Department=Please fill me in\n")
                    outFile.write("Email={}\n".format(row['Email']))
                    outFile.write("Address 1=Please fill me in\n")
                    outFile.write("State/Province=MA\n")
                    outFile.write("Location Code=US\n")
                    outFile.write("Location=US\n")
                    outFile.write("Zip/Postal Code=00000-0000\n")
                    outFile.write("Phone Number=000-000-0000\n")
                    outFile.write("\n")
                    outFile.write("// Features and authorization numbers\n")
                    with open(DeskSingAuthFile,'r') as authCodes: # Brings in authorization codes from external file so I don't have to hardcode them each year + folks on github don't steal our licenses
                        for x in authCodes: # Python automagically loads the text file as if each line in it were an item in a list.
                            outFile.write(x)
                    outFile.write("\n")
                print("Done writing file {}".format(outFileNameAndPath))
                # print(outFilenName)

            # Generate Concurrent use ArcDesktop licenses
            elif row['License Type'] == "Concurrent Use":
                print("Generating ArcPro Concurrent Use license for row{}".format(row_num))
                outFileName = str(row['Institution'] + "_ArcGIS" + row['Product'] + "_" + row['License Type'] + "_for_" + row['FirstName'] + "_" + row['LastName'] + "_" + str(row['Kopera File ID'])+r".prvs")
                outFileNameAndPath = str("{}/{}".format(outPath,outFileName))
                with open(outFileNameAndPath,'a', encoding='cp1252') as outFile:
                    outFile.write("// {}\n".format(outFileName))
                    outFile.write("\n")
                    outFile.write("//Provision\n")
                    outFile.write("Comment={}".format(str(row['Institution'] + ": " + "ArcGIS"+row['Product'] + " " + row['License Type'] + " License" + " for " + row['FirstName'] + " " + row['LastName'] + ", " + row['Seats'] + " seats\n")))
                    outFile.write("\n")
                    outFile.write("\n")
                    outFile.write("// User Information\n")
                    outFile.write("First Name={}\n".format(row['FirstName']))
                    outFile.write("Last Name={}\n".format(row['LastName']))
                    outFile.write("Department=Please fill me in\n")
                    outFile.write("Organization=Please fill me in\n")
                    outFile.write("Department=Please fill me in\n")
                    outFile.write("Email={}\n".format(row['Email']))
                    outFile.write("Address 1=Please fill me in\n")
                    outFile.write("State/Province=MA\n")
                    outFile.write("Location Code=US\n")
                    outFile.write("Location=US\n")
                    outFile.write("Zip/Postal Code=00000-0000\n")
                    outFile.write("Phone Number=000-000-0000\n")
                    outFile.write("\n")
                    outFile.write("// Features and authorization numbers\n")
                    with open(DeskConcAuthFile,'r') as authCodes: # Brings in authorization codes from external file so I don't have to hardcode them each year + folks on github don't steal our licenses
                        for x in authCodes: # Python automagically loads the text file as if each line in it were an item in a list.
                            lineOut = x.rstrip("\n") + "=" + row['Seats'] + "\n"
                            outFile.write(lineOut)
                print("Done writing file {}".format(outFileNameAndPath))

print("Done processing file with total of {} entries".format(row_num))


